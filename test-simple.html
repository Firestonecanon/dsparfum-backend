<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob: http: https:;">
<title>Test</title>
<style>
body{font:16px Arial;margin:15px;background:#eee;}
.card{background:#fff;padding:20px;border-radius:8px;margin:10px 0;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.btn{background:#28a745;color:#fff;border:none;padding:12px 24px;border-radius:4px;margin:8px 4px;cursor:pointer;font-size:14px;}
.btn:hover{background:#218838;}
.btn.danger{background:#dc3545;}
.btn.danger:hover{background:#c82333;}
.log{background:#f8f9fa;border:1px solid #dee2e6;padding:10px;margin:10px 0;border-radius:4px;font-family:monospace;font-size:12px;max-height:300px;overflow-y:auto;}
.error{background:#f8d7da;border-color:#f5c6cb;color:#721c24;}
.success{background:#d4edda;border-color:#c3e6cb;color:#155724;}
</style>
</head>
<body>

<div class="card">
<h2>üîß Test Diagnostic Mobile</h2>
<p>Interface de test sans restrictions</p>
<div>
<button class="btn" onclick="testEnvironment()">üì± Test Environment</button>
<button class="btn" onclick="testLocalAPI()">üè† API Local</button>
<button class="btn" onclick="testProdAPI()">üåê API Prod</button>
<button class="btn danger" onclick="clearLog()">üóëÔ∏è Clear</button>
</div>
</div>

<div class="card">
<h3>üìã Log de Diagnostic</h3>
<div id="log" class="log">Pr√™t pour les tests...<br></div>
</div>

<script>
let logCount = 0;

function addLog(message, type = 'info') {
  logCount++;
  const timestamp = new Date().toLocaleTimeString();
  const logDiv = document.getElementById('log');
  const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
  logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
  logDiv.scrollTop = logDiv.scrollHeight;
  console.log(`[${type.toUpperCase()}] ${message}`);
}

function clearLog() {
  document.getElementById('log').innerHTML = 'Log vid√©...<br>';
  logCount = 0;
}

function testEnvironment() {
  addLog('=== DIAGNOSTIC ENVIRONNEMENT ===');
  addLog(`URL actuelle: ${window.location.href}`);
  addLog(`Navigateur: ${navigator.userAgent}`);
  addLog(`Plateforme: ${navigator.platform}`);
  addLog(`Mobile d√©tect√©: ${/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}`);
  addLog(`Android d√©tect√©: ${/Android/i.test(navigator.userAgent)}`);
  addLog(`Taille √©cran: ${window.innerWidth}x${window.innerHeight}`);
  addLog(`R√©solution: ${screen.width}x${screen.height}`);
  addLog(`Touch support: ${'ontouchstart' in window}`);
  addLog(`Online: ${navigator.onLine}`);
  addLog('Test environnement termin√©', 'success');
}

async function testLocalAPI() {
  addLog('=== TEST API LOCALE ===');
  const url = 'http://localhost:3001/api/admin/clients';
  addLog(`Tentative: ${url}`);
  
  try {
    const startTime = performance.now();
    const response = await fetch(url, {
      method: 'GET',
      mode: 'cors',
      cache: 'no-cache',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    const endTime = performance.now();
    
    addLog(`R√©ponse re√ßue en ${Math.round(endTime - startTime)}ms`);
    addLog(`Status: ${response.status} ${response.statusText}`);
    addLog(`Headers: ${JSON.stringify([...response.headers.entries()])}`);
    
    if (response.ok) {
      const data = await response.json();
      const clientCount = Array.isArray(data) ? data.length : (data.clients ? data.clients.length : 0);
      addLog(`Donn√©es re√ßues: ${clientCount} clients`, 'success');
      if (clientCount > 0) {
        const sample = Array.isArray(data) ? data[0] : data.clients[0];
        addLog(`Exemple client: ID=${sample.id}, Email=${sample.email}`);
      }
    } else {
      addLog(`Erreur HTTP: ${response.status}`, 'error');
    }
  } catch (error) {
    addLog(`ERREUR: ${error.name} - ${error.message}`, 'error');
    addLog(`Stack: ${error.stack}`, 'error');
  }
}

async function testProdAPI() {
  addLog('=== TEST API PRODUCTION ===');
  const url = 'https://api.dsparfum.fr/api/admin/clients';
  addLog(`Tentative: ${url}`);
  
  try {
    const startTime = performance.now();
    const response = await fetch(url, {
      method: 'GET',
      mode: 'cors',
      cache: 'no-cache',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    const endTime = performance.now();
    
    addLog(`R√©ponse re√ßue en ${Math.round(endTime - startTime)}ms`);
    addLog(`Status: ${response.status} ${response.statusText}`);
    
    if (response.ok) {
      const data = await response.json();
      const clientCount = Array.isArray(data) ? data.length : (data.clients ? data.clients.length : 0);
      addLog(`API Production OK: ${clientCount} clients`, 'success');
    } else {
      addLog(`Erreur API Production: ${response.status}`, 'error');
    }
  } catch (error) {
    addLog(`ERREUR API Production: ${error.message}`, 'error');
  }
}

// Auto-initialisation
document.addEventListener('DOMContentLoaded', function() {
  addLog('üöÄ Interface diagnostic initialis√©e', 'success');
  addLog('Cliquez sur les boutons pour commencer les tests');
});

// Gestion des erreurs globales
window.addEventListener('error', function(e) {
  addLog(`ERREUR GLOBALE: ${e.message} √† ${e.filename}:${e.lineno}`, 'error');
});

window.addEventListener('unhandledrejection', function(e) {
  addLog(`PROMESSE REJET√âE: ${e.reason}`, 'error');
});
</script>

</body>
</html>
