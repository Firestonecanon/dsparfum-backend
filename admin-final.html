<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- AUCUNE META CSP - LET SERVER HANDLE IT -->
<title>Admin Mobile Final</title>
<style>
body{font:16px Arial;margin:10px;background:#f0f2f5;}
.container{max-width:100%;margin:0 auto;}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.card{background:white;padding:20px;border-radius:12px;margin:15px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid #e1e5e9;}
.btn{background:#28a745;color:white;border:none;padding:14px 24px;border-radius:8px;margin:8px 4px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;min-width:140px;}
.btn:active{transform:scale(0.95);background:#1e7e34;}
.btn.primary{background:#007bff;}
.btn.primary:active{background:#0056b3;}
.btn.danger{background:#dc3545;}
.btn.danger:active{background:#bd2130;}
.btn.warning{background:#ffc107;color:#212529;}
.btn.warning:active{background:#d39e00;}
.status{padding:15px;margin:15px 0;border-radius:8px;font-weight:600;border:2px solid;}
.status.success{background:#d4edda;color:#155724;border-color:#c3e6cb;}
.status.error{background:#f8d7da;color:#721c24;border-color:#f5c6cb;}
.status.info{background:#d1ecf1;color:#0c5460;border-color:#bee5eb;}
.status.warning{background:#fff3cd;color:#856404;border-color:#ffeaa7;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0;}
.stat{background:#f8f9fa;padding:15px;border-radius:8px;text-align:center;border:1px solid #dee2e6;}
.stat-number{font-size:24px;font-weight:bold;color:#007bff;margin-bottom:5px;}
.stat-label{font-size:12px;color:#6c757d;text-transform:uppercase;letter-spacing:1px;}
.clients-list{max-height:400px;overflow-y:auto;border:1px solid #dee2e6;border-radius:8px;background:#f8f9fa;}
.client-item{padding:12px;border-bottom:1px solid #e9ecef;background:white;margin:2px;}
.client-item:last-child{border-bottom:none;}
.client-id{font-weight:bold;color:#007bff;}
.client-email{color:#6c757d;font-size:13px;}
.client-revenue{color:#28a745;font-weight:600;}
@media (max-width:768px) {
  .header{padding:15px;}
  .card{padding:15px;margin:10px 0;}
  .btn{padding:12px 16px;margin:4px 2px;min-width:120px;font-size:13px;}
  .grid{grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
  .stat-number{font-size:20px;}
}
</style>
</head>
<body>

<div class="container">
<div class="header">
<h1>🌟 Admin DS Parfum</h1>
<p>Interface mobile ultra-optimisée</p>
<div style="font-size:12px;margin-top:10px;opacity:0.8;">
Version finale sans restrictions CSP
</div>
</div>

<div class="card">
<h3>🎛️ Contrôles Principaux</h3>
<div style="text-align:center;">
<button class="btn primary" onclick="loadClients()">📊 Charger Clients</button>
<button class="btn warning" onclick="exportData()">💾 Export JSON</button>
<button class="btn" onclick="refreshStats()">🔄 Actualiser</button>
<button class="btn danger" onclick="clearAll()">🗑️ Effacer</button>
</div>
</div>

<div class="card">
<h3>📈 Statistiques Temps Réel</h3>
<div id="stats-grid" class="grid">
<div class="stat">
<div class="stat-number" id="total-clients">-</div>
<div class="stat-label">Total Clients</div>
</div>
<div class="stat">
<div class="stat-number" id="total-revenue">-</div>
<div class="stat-label">CA Total</div>
</div>
<div class="stat">
<div class="stat-number" id="avg-revenue">-</div>
<div class="stat-label">CA Moyen</div>
</div>
<div class="stat">
<div class="stat-number" id="recent-clients">-</div>
<div class="stat-label">Nouveaux 7j</div>
</div>
</div>
</div>

<div class="card">
<h3>👥 Liste des Clients</h3>
<div id="clients-container">
<div class="status info">
Cliquez sur "Charger Clients" pour afficher les données
</div>
</div>
</div>

<div class="card">
<h3>📱 Statut & Debug</h3>
<div id="status-container">
<div class="status info">
Interface initialisée et prête
</div>
</div>
</div>

</div>

<script>
let allClients = [];
let isLoading = false;

function log(message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const statusContainer = document.getElementById('status-container');
  const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
  
  statusContainer.innerHTML = `<div class="status ${statusClass}">[${timestamp}] ${message}</div>`;
  console.log(`[${type.toUpperCase()}] ${message}`);
}

function getApiBaseUrl() {
  const hostname = window.location.hostname;
  if (hostname === 'localhost' || hostname.startsWith('192.168.') || hostname.startsWith('10.') || hostname.startsWith('172.')) {
    return window.location.origin;
  }
  return 'https://api.dsparfum.fr';
}

async function loadClients() {
  if (isLoading) {
    log('Chargement déjà en cours...', 'warning');
    return;
  }
  
  isLoading = true;
  log('🔄 Chargement des clients...', 'info');
  
  const apiUrl = getApiBaseUrl();
  log(`API URL: ${apiUrl}`, 'info');
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
    
    const response = await fetch(`${apiUrl}/api/admin/clients`, {
      method: 'GET',
      signal: controller.signal,
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Cache-Control': 'no-cache'
      }
    });
    
    clearTimeout(timeoutId);
    
    log(`Réponse HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    allClients = Array.isArray(data) ? data : (data.clients || []);
    
    log(`✅ ${allClients.length} clients chargés avec succès`, 'success');
    
    updateStats();
    displayClients();
    
  } catch (error) {
    if (error.name === 'AbortError') {
      log('⏰ Timeout: Chargement annulé après 10s', 'error');
    } else {
      log(`❌ Erreur: ${error.message}`, 'error');
    }
    console.error('Erreur détaillée:', error);
  } finally {
    isLoading = false;
  }
}

function updateStats() {
  const total = allClients.length;
  const totalRevenue = allClients.reduce((sum, c) => sum + (parseFloat(c.total_revenue) || 0), 0);
  const avgRevenue = total > 0 ? totalRevenue / total : 0;
  
  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  const recentClients = allClients.filter(c => new Date(c.created_at) > weekAgo).length;
  
  document.getElementById('total-clients').textContent = total;
  document.getElementById('total-revenue').textContent = totalRevenue.toFixed(0) + '€';
  document.getElementById('avg-revenue').textContent = avgRevenue.toFixed(0) + '€';
  document.getElementById('recent-clients').textContent = recentClients;
}

function displayClients() {
  const container = document.getElementById('clients-container');
  
  if (allClients.length === 0) {
    container.innerHTML = '<div class="status warning">Aucun client trouvé dans la base de données</div>';
    return;
  }
  
  const clientsToShow = allClients.slice(0, 100); // Limite pour performance mobile
  
  let html = '<div class="clients-list">';
  clientsToShow.forEach(client => {
    const revenue = parseFloat(client.total_revenue) || 0;
    const date = new Date(client.created_at).toLocaleDateString('fr-FR');
    
    html += `
      <div class="client-item">
        <div class="client-id">#${client.id} ${client.name || 'Sans nom'}</div>
        <div class="client-email">📧 ${client.email}</div>
        <div class="client-revenue">💰 ${revenue.toFixed(2)}€ | 📅 ${date}</div>
      </div>
    `;
  });
  html += '</div>';
  
  if (allClients.length > 100) {
    html += `<div class="status info" style="margin-top:10px;">Affichage des 100 premiers clients sur ${allClients.length} total</div>`;
  }
  
  container.innerHTML = html;
}

function exportData() {
  if (allClients.length === 0) {
    log('⚠️ Aucune donnée à exporter - Chargez d\'abord les clients', 'warning');
    return;
  }
  
  try {
    const exportData = {
      timestamp: new Date().toISOString(),
      total: allClients.length,
      source: 'mobile-interface',
      api_url: getApiBaseUrl(),
      clients: allClients
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `dsparfum-mobile-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    log(`✅ Export réussi: ${allClients.length} clients`, 'success');
  } catch (error) {
    log(`❌ Erreur export: ${error.message}`, 'error');
  }
}

function refreshStats() {
  if (allClients.length > 0) {
    updateStats();
    log('📊 Statistiques actualisées', 'success');
  } else {
    log('⚠️ Aucune donnée - Chargez d\'abord les clients', 'warning');
  }
}

function clearAll() {
  if (confirm('Effacer toutes les données affichées ?')) {
    allClients = [];
    document.getElementById('clients-container').innerHTML = '<div class="status info">Données effacées</div>';
    document.getElementById('total-clients').textContent = '-';
    document.getElementById('total-revenue').textContent = '-';
    document.getElementById('avg-revenue').textContent = '-';
    document.getElementById('recent-clients').textContent = '-';
    log('🗑️ Toutes les données ont été effacées', 'info');
  }
}

// Initialisation automatique
document.addEventListener('DOMContentLoaded', function() {
  log(`🚀 Interface mobile initialisée - API: ${getApiBaseUrl()}`, 'success');
  
  // Test de connectivité automatique après 2 secondes
  setTimeout(() => {
    log('🔍 Lancement du test de connectivité automatique...', 'info');
    loadClients();
  }, 2000);
});

// Gestion des erreurs globales
window.addEventListener('error', function(e) {
  log(`💥 Erreur JavaScript: ${e.message} (${e.filename}:${e.lineno})`, 'error');
});

window.addEventListener('unhandledrejection', function(e) {
  log(`💥 Promesse rejetée: ${e.reason}`, 'error');
});

// Détection de la perte de connexion
window.addEventListener('online', () => log('🌐 Connexion internet rétablie', 'success'));
window.addEventListener('offline', () => log('📵 Connexion internet perdue', 'warning'));
</script>

</body>
</html>
